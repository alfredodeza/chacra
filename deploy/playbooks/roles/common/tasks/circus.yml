---

- name: install circus in virtualenv
  sudo: true
  pip: name={{ item }} state=present virtualenv={{ app_home }}
  with_items:
    - circus
    - circus-web
    - chaussette

- name: ensure /etc/circus exists
  file:
    path: /etc/circus
    state: directory
    owner: root
    group: root
    mode: 0755
    recurse: yes
  sudo: true

- name: ensure /var/log/circus exists
  file:
    path: /var/log/circus
    state: directory
    owner: "{{ app_user }}"
    group: root
    mode: 0755
    recurse: yes
  sudo: true

- name: ensure {{ app_home }}/log exists
  sudo: true
  file:
    path: "{{ app_home }}/log"
    state: directory
    owner: "{{ app_user }}"
    group: root
    mode: 0755
    recurse: yes

- name: install circus.conf init file
  template:
    src: circus.conf
    dest: /etc/init/circus.conf
    owner: root
    group: root
    mode: 0644
  sudo: true
  register: circus_service

- name: enable circus
  sudo: true
  service:
    name: circus
    enabled: yes

- name: install circus conf for {{ app_name }}
  template: src=circus.ini.j2 dest=/etc/circus/circus.ini
  sudo: true
  notify: reload circus config

- name: ensure circus is running
  sudo: true
  service:
    name: circus
    state: started
